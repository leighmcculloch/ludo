<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Path Bug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Home Path Entry Bug Test</h1>
        <p>This test reproduces the bug where pieces enter their home path too early, before completing a full circuit around the board.</p>
        
        <div id="testResults"></div>
        
        <div class="test-info">
            <h3>Test Scenarios:</h3>
            <ul>
                <li><strong>Scenario 1:</strong> Green piece at position 30 (near yellow area) trying to move</li>
                <li><strong>Scenario 2:</strong> Blue piece at position 40 (in yellow area) trying to move</li>
                <li><strong>Scenario 3:</strong> Red piece at position 50 (near starting area) trying to move</li>
                <li><strong>Scenario 4:</strong> Yellow piece at position 10 (in red area) trying to move</li>
            </ul>
        </div>
    </div>

    <script>
        // Copy the game logic from index.html
        const boardPath = [
            [6, 1], [6, 2], [6, 3], [6, 4], [6, 5], [6, 6], // Red starting area
            [5, 6], [4, 6], [3, 6], [2, 6], [1, 6], [0, 6], // Top side
            [0, 7], [0, 8], // Top corner
            [1, 8], [2, 8], [3, 8], [4, 8], [5, 8], [6, 8], // Blue starting area
            [6, 9], [6, 10], [6, 11], [6, 12], [6, 13], [6, 14], // Right side
            [7, 14], [8, 14], // Right corner
            [8, 13], [8, 12], [8, 11], [8, 10], [8, 9], [8, 8], // Green starting area
            [9, 8], [10, 8], [11, 8], [12, 8], [13, 8], [14, 8], // Bottom side
            [14, 7], [14, 6], // Bottom corner
            [13, 6], [12, 6], [11, 6], [10, 6], [9, 6], [8, 6], // Yellow starting area
            [8, 5], [8, 4], [8, 3], [8, 2], [8, 1], [8, 0], // Left side
            [7, 0], [6, 0] // Left corner back to start
        ];

        const homePaths = {
            red: [[7, 1], [7, 2], [7, 3], [7, 4], [7, 5], [7, 6]],
            blue: [[1, 7], [2, 7], [3, 7], [4, 7], [5, 7], [6, 7]],
            green: [[7, 13], [7, 12], [7, 11], [7, 10], [7, 9], [7, 8]],
            yellow: [[13, 7], [12, 7], [11, 7], [10, 7], [9, 7], [8, 7]]
        };

        const startPositions = {
            red: 1,
            blue: 14,
            green: 28,
            yellow: 42
        };

        // Copy the current buggy calculateNewPosition function
        function calculateNewPositionBuggy(color, currentPos, moves) {
            if (currentPos === null) {
                if (moves === 6) {
                    return startPositions[color];
                }
                return null;
            }
            
            if (currentPos === 'center') {
                return null;
            }
            
            let newPos = currentPos + moves;
            
            // Check if should enter home path - THIS IS THE BUGGY LOGIC
            const homePathStart = startPositions[color] + 51;
            if (currentPos < homePathStart && newPos >= homePathStart) {
                // Enter home path
                const homePathIndex = newPos - homePathStart;
                if (homePathIndex < homePaths[color].length) {
                    return boardPath.length + homePathIndex;
                } else if (homePathIndex === homePaths[color].length) {
                    return 'center';
                } else {
                    return null; // Overshoot
                }
            }
            
            // Normal board movement
            if (newPos >= boardPath.length) {
                // Check if in home path
                const homePathIndex = newPos - boardPath.length;
                if (homePathIndex < homePaths[color].length) {
                    return boardPath.length + homePathIndex;
                } else if (homePathIndex === homePaths[color].length) {
                    return 'center';
                } else {
                    return null; // Overshoot
                }
            }
            
            return newPos % boardPath.length;
        }

        // Fixed calculateNewPosition function
        function calculateNewPosition(color, currentPos, moves) {
            if (currentPos === null) {
                // Moving from home
                if (moves === 6) {
                    return startPositions[color];
                }
                return null;
            }
            
            if (currentPos === 'center') {
                return null; // Can't move from center
            }
            
            let newPos = currentPos + moves;
            
            // Check if should enter home path
            // A piece can only enter home path if it's at the correct entrance position
            const homePathEntrancePos = (startPositions[color] + 51) % boardPath.length;
            
            // Check if the piece is at the home entrance position
            if (currentPos === homePathEntrancePos) {
                // Piece is at home entrance, move into home path
                const homePathIndex = moves - 1; // First move takes us to the first home path position
                if (homePathIndex < homePaths[color].length) {
                    return boardPath.length + homePathIndex;
                } else if (homePathIndex === homePaths[color].length) {
                    return 'center';
                } else {
                    return null; // Overshoot
                }
            }
            
            // Handle normal board movement with wrapping
            if (newPos >= boardPath.length) {
                newPos = newPos % boardPath.length;
            }
            
            return newPos;
        }

        function addTestResult(testName, passed, details) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = passed ? 'test-result test-pass' : 'test-result test-fail';
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${passed ? 'PASS' : 'FAIL'}<br>${details}`;
            resultsDiv.appendChild(resultDiv);
        }

        function runTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h2>Test Results:</h2>';

            // Test 1: Green piece at position 30 (should NOT enter home path)
            const greenResult = calculateNewPosition('green', 30, 6);
            const greenShouldNotEnterHome = greenResult !== null && greenResult < boardPath.length;
            addTestResult(
                'Green piece at position 30 moving 6 squares (FIXED)', 
                greenShouldNotEnterHome,
                `Expected: Normal board movement (position < ${boardPath.length}), Got: ${greenResult}. HomePathEntrancePos: ${(startPositions.green + 51) % boardPath.length}`
            );

            // Test 2: Blue piece at position 40 (should NOT enter home path)
            const blueResult = calculateNewPosition('blue', 40, 6);
            const blueShouldNotEnterHome = blueResult !== null && blueResult < boardPath.length;
            addTestResult(
                'Blue piece at position 40 moving 6 squares (FIXED)', 
                blueShouldNotEnterHome,
                `Expected: Normal board movement (position < ${boardPath.length}), Got: ${blueResult}. HomePathEntrancePos: ${(startPositions.blue + 51) % boardPath.length}`
            );

            // Test 3: Red piece at position 50 (should NOT enter home path yet)
            const redResult = calculateNewPosition('red', 50, 6);
            const redShouldNotEnterHome = redResult !== null && redResult < boardPath.length;
            addTestResult(
                'Red piece at position 50 moving 6 squares (FIXED)', 
                redShouldNotEnterHome,
                `Expected: Normal board movement (position < ${boardPath.length}), Got: ${redResult}. HomePathEntrancePos: ${(startPositions.red + 51) % boardPath.length}`
            );

            // Test 4: Yellow piece at position 10 (should NOT enter home path)
            const yellowResult = calculateNewPosition('yellow', 10, 6);
            const yellowShouldNotEnterHome = yellowResult !== null && yellowResult < boardPath.length;
            addTestResult(
                'Yellow piece at position 10 moving 6 squares (FIXED)', 
                yellowShouldNotEnterHome,
                `Expected: Normal board movement (position < ${boardPath.length}), Got: ${yellowResult}. HomePathEntrancePos: ${(startPositions.yellow + 51) % boardPath.length}`
            );

            // Test 5: Test pieces at home path entrance positions
            const redEntrancePos = (startPositions.red + 51) % boardPath.length;
            const redAtEntranceResult = calculateNewPosition('red', redEntrancePos, 6);
            const redShouldEnterHome = redAtEntranceResult !== null && redAtEntranceResult >= boardPath.length;
            addTestResult(
                `Red piece at home entrance position ${redEntrancePos} moving 6 squares (SHOULD ENTER HOME)`, 
                redShouldEnterHome,
                `Expected: Home path entry (position >= ${boardPath.length}), Got: ${redAtEntranceResult}`
            );

            const greenEntrancePos = (startPositions.green + 51) % boardPath.length;
            const greenAtEntranceResult = calculateNewPosition('green', greenEntrancePos, 6);
            const greenShouldEnterHome = greenAtEntranceResult !== null && greenAtEntranceResult >= boardPath.length;
            addTestResult(
                `Green piece at home entrance position ${greenEntrancePos} moving 6 squares (SHOULD ENTER HOME)`, 
                greenShouldEnterHome,
                `Expected: Home path entry (position >= ${boardPath.length}), Got: ${greenAtEntranceResult}`
            );

            // Test 6: Show board path length
            addTestResult(
                'Board path length', 
                true,
                `Board path has ${boardPath.length} positions (0-${boardPath.length - 1})`
            );

            // Test 7: Show corrected homePathEntrance calculations
            const calculations = Object.keys(startPositions).map(color => {
                const homePathEntrancePos = (startPositions[color] + 51) % boardPath.length;
                return `${color}: (${startPositions[color]} + 51) % ${boardPath.length} = ${homePathEntrancePos}`;
            }).join(', ');
            addTestResult(
                'Fixed HomePathEntrance calculations', 
                true,
                `All within board range: ${calculations}`
            );

            // Test 8: Compare with buggy version
            const buggyRedResult = calculateNewPositionBuggy('red', 50, 6);
            addTestResult(
                'Comparison: Red piece at position 50 (buggy vs fixed)', 
                redResult !== buggyRedResult,
                `Buggy version: ${buggyRedResult}, Fixed version: ${redResult}`
            );
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>